$(document).ready(function(){function d(){finalizedEvents=a.weekCalendar("serializeAllEvents"),finalizedEvents.map(g),json=JSON.stringify(finalizedEvents),$.ajax({type:"PUT",beforeSend:function(a){a.setRequestHeader("Accept","application/json")},url:window.location.pathname,data:{calendar_updates:json},dataType:"json",success:function(a,b,c){},error:function(a,b,c){}})}function e(){$.ajax({type:"GET",beforeSend:function(a){a.setRequestHeader("Accept","application/json")},url:window.location.pathname,dataType:"json",success:function(a){a.map(f),c=a,h()}})}function f(a){timezone_offset=(new Date).getTimezoneOffset(),a.start_time=Date.parse(a.start_time).add(-timezone_offset).minutes().add(-2).hours(),a.end_time=Date.parse(a.end_time).add(-timezone_offset).minutes().add(-2).hours()}function g(a){a.start_time=a.start_time.add(2).hours(),a.end_time=a.end_time.add(2).hours()}function h(){a.weekCalendar({displayOddEven:!0,timeslotsPerHour:2,allowCalEventOverlap:!1,overlapEventsSeparate:!0,firstDayOfWeek:0,businessHours:{start_time:6,end_time:24,limitDisplay:!0},daysToShow:7,title:function(a){return a==1?"%date%":"%start% - %end%"},height:function(a){return 760},eventRender:function(a,b){a.entry_type==="rather_not"?(b.css("backgroundColor","#c6c"),b.find(".wc-time").css({backgroundColor:"#a4a",border:"1px solid #949"})):a.entry_type==="obligation"?(b.css("backgroundColor","#3c6"),b.find(".wc-time").css({backgroundColor:"#1a4",border:"1px solid #093"})):a.entry_type==="class"?(b.css("backgroundColor","#f23"),b.find(".wc-time").css({backgroundColor:"#c12",border:"1px solid #b12"})):a.entry_type==="closed"&&(b.css("backgroundColor","#aaa"),b.find(".wc-time").css({backgroundColor:"#999",border:"1px solid #888"}))},draggable:function(a,b){return a.readOnly!=1},resizable:function(a,b){return a.readOnly!=1},eventNew:function(c,d){currentType=$("input[name=entry_type_select]:checked").val(),c.entry_type=currentType;if(currentType=="obligation"){var e=$("#event_edit_container");i(e);var f=e.find("select[name='start']").val(c.start_time),g=e.find("select[name='end']").val(c.end_time),h=e.find("select[name='entry_type']").val(c.entry_type),k=e.find("textarea[name='description']");n(),e.dialog({modal:!0,title:"New Calendar Event",close:function(){e.dialog("destroy"),e.hide(),$("#calendar").weekCalendar("removeUnsavedEvents")},buttons:{save:function(){c.id=b,b++,c.start_time=new Date(f.val()),c.end_time=new Date(g.val()),c.entry_type=h.val(),c.description=k.val(),a.weekCalendar("removeUnsavedEvents"),a.weekCalendar("updateEvent",c),e.dialog("close")},cancel:function(){e.dialog("close")}}}).show(),e.find(".date_holder").text(a.weekCalendar("formatDate",c.start_time)),j(f,g,c,a.weekCalendar("getTimeslotTimes",c.start_time))}else c.id=b,b++,a.weekCalendar("removeUnsavedEvents"),a.weekCalendar("updateEvent",c)},eventDrop:function(a,b){},eventResize:function(b,c){a.weekCalendar("updateEvent",b)},eventClick:function(b,c){if(b.readOnly)return;var d=$("#event_edit_container");i(d);var e=d.find("select[name='start']").val(b.start_time),f=d.find("select[name='end']").val(b.end_time),g=d.find("select[name='entry_type']").val(b.entry_type),h=d.find("textarea[name='description']").val(b.description);n(),d.dialog({modal:!0,title:"Edit - "+b.entry_type,close:function(){d.dialog("destroy"),d.hide(),$("#calendar").weekCalendar("removeUnsavedEvents")},buttons:{save:function(){b.start_time=new Date(e.val()),b.end_time=new Date(f.val()),b.entry_type=g.val(),b.description=h.val(),a.weekCalendar("updateEvent",b),d.dialog("close")},"delete":function(){a.weekCalendar("removeEvent",b.id),d.dialog("close")},cancel:function(){d.dialog("close")}}}).show();var e=d.find("select[name='start']").val(b.start_time),f=d.find("select[name='end']").val(b.end_time);d.find(".date_holder").text(a.weekCalendar("formatDate",b.start_time)),j(e,f,b,a.weekCalendar("getTimeslotTimes",b.start_time)),$(window).resize().resize()},eventMouseover:function(a,b){},eventMouseout:function(a,b){},noEvents:function(){},data:c})}function i(a){a.find("input").val(""),a.find("textarea").val("")}function j(a,b,c,d){a.empty(),b.empty();for(var e=0;e<d.length;e++){var f=d[e].start,g=d[e].end,h="";f.getTime()===c.start_time.getTime()&&(h='selected="selected"');var i="";g.getTime()===c.end_time.getTime()&&(i='selected="selected"'),a.append('<option value="'+f+'" '+h+">"+d[e].startFormatted+"</option>"),b.append('<option value="'+g+'" '+i+">"+d[e].endFormatted+"</option>"),m.start[d[e].startFormatted]=f.getTime(),m.end[d[e].endFormatted]=g.getTime()}l=b.find("option"),a.trigger("change")}function n(){$("select[name='entry_type']").val()==="obligation"?document.getElementById("description").style.display="block":($("#description > textarea").val(""),document.getElementById("description").style.display="none")}var a=$("#calendar"),b=999999999,c;$("#submit_calendar").bind("click",d),e();var k=$("select[name='end']"),l=k.find("option"),m={start:[],end:[]};$("select[name='start']").change(function(){var a=m.start[$(this).find(":selected").text()],b=k.find("option:selected").val();k.html(l.filter(function(){return a<m.end[$(this).text()]}));var c=!1;k.find("option").each(function(){if($(this).val()===b)return $(this).attr("selected","selected"),c=!0,!1}),c||k.find("option:eq(1)").attr("selected","selected")}),$("select[name='entry_type']").change(n)});